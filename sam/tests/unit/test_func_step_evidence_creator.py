import json
import typing
import uuid
from datetime import datetime, timezone
from operator import itemgetter
from pathlib import Path
from random import random
from unittest import mock

import boto3
import pandas as pd
import pytest
from chatbot_cloud_util import util
from chatbot_cloud_util.mixins import WebSocketEnabledApiGatewayEvent
from chatbot_cloud_util.state import AssertionsCreatorState, EvidenceCreatorState
from chatbot_validator.corpus import CorpusChain, CorpusCreator
from chatbot_validator.evidence import Evidence
from langchain.embeddings import FakeEmbeddings
from moto import mock_s3, mock_secretsmanager
from vector_store_faissdb import CorpusContainer


def search_data():
    return {
        'openalex_id': {
            '1': 'https://openalex.org/W2382069847',
            '2': 'https://openalex.org/W2762533726',
            '3': 'https://openalex.org/W2011950085',
            '4': 'https://openalex.org/W2886742958',
            '6': 'https://openalex.org/W4288260252',
            '7': 'https://openalex.org/W2022734373',
            '8': 'https://openalex.org/W2143987241',
            '9': 'https://openalex.org/W3102087921',
            '10': 'https://openalex.org/W2341748326',
            '11': 'https://openalex.org/W1872986167',
        },
        'title': {
            '1': 'Mechanical Energy Evolution of the Planet System and the General Formula for Kepler\'s Third Law with the Evolutionary Synchronism of Celestial Body',
            '2': 'Changing Coordinates in the Context of Orbital Mechanics',
            '3': 'Development of Experienced Science Teachers\u2019 Pedagogical Content Knowledge of Models of the Solar System and the Universe',
            '4': 'Closed periodic orbits in anomalous gravitation',
            '6': 'Network constraints in scale free dynamical systems',
            '7': 'WHY IS THE SOLAR CONSTANT NOT A CONSTANT?',
            '8': 'New Opportunities for a Historic Spacecraft',
            '9': 'TRIGONOMETRIC PARALLAXES OF HIGH MASS STAR FORMING REGIONS: THE STRUCTURE AND KINEMATICS OF THE MILKY WAY',
            '10': 'Questioning Einstein: Is Relativity Necessary?',
            '11': 'Herding, social influences and behavioural bias in scientific research',
        },
        'abstract': {
            '1': 'This article has established the mathematical model of the changes of the mechanical energy for the planet system with the gravitational constant reduction.By analysing and demonstrating to the mathematical model,the general formula of Kepler\'s third law with the evolutionary synchronism of celestial body is derived.The current state of planetary motion is the current form with historical evolution.By theoretical modeling to the general formula of Kepler\'s third law,this article has explained the physical meaning of Kepler\'s third law,and has achieved traceability for the evolution of planetary orbits in the solar system and forecastability for the future.',
            '2': 'Abstract : This note works through an example of switching between many coordinate systems using a modern matrix language that lends itself to describing arenas with multiple entities such as found in many Defence scenarios. To this end, it describes an example in planetary orbital theory, whose various Sun- and Earth-centred coordinate systems makes that theory a good test-bed for such an exposition of changing coordinates. In particular, we predict the look direction to Jupiter from a given place on Earth at a given time, highlighting the careful book-keeping that is required along the way. To avoid much of the rather antiquated jargon and notation that pervades orbital theory, we explain the first principles of 2-body orbital motion (Kepler\'s theory), beginning with Newton\'s laws and proving all the necessary expressions. The systematic and modern approach to changing coordinates described here can also be applied just as readily in contexts such as a Defence aerospace engagement, which follows the interaction of multiple entities that each carry their own coordinate system.',
            '3': 'This paper investigates the developing pedagogical content knowledge (PCK) of nine experienced science teachers in their first few years of teaching a new science syllabus in the Dutch secondary education system. We aimed to identify the content and structure of the PCK for a specific topic in the new syllabus, \u2018Models of the Solar System and the Universe\u2019, describing the PCK development in terms of relations between four different aspects: knowledge about instructional strategies; knowledge about students\u2019 understanding; knowledge about assessment of students; and knowledge about goals and objectives of the topic in the curriculum. Semi\u2010structured interviews were conducted in three subsequent academic years. From the analysis of the data, two qualitatively different types of PCK emerged. Type A can be described as oriented towards model content, while Type B can be typified as oriented towards model content, model production, and thinking about the nature of models. The results also indicate that these t...',
            '4': 'Newton famously showed that a gravitational force inversely proportional to the square of the distance, $F \\sim 1/r^2$, formally explains Kepler\'s three laws of planetary motion. But what happens to the familiar elliptical orbits if the force were to taper off with a different spatial exponent? Here we expand generic textbook treatments by a detailed geometric characterisation of the general solution to the equation of motion for a two-body "sun/planet" system under anomalous gravitation $F \\sim 1/r^{\\alpha} (1 \\leq \\alpha < 2)$. A subset of initial conditions induce closed self-intersecting periodic orbits resembling hypotrochoids with perihelia and aphelia forming regular polygons. We provide time-resolved trajectories for a variety of exponents $\\alpha$, and discuss conceptual connections of the case $\\alpha = 1$ to Modified Newtonian Dynamics and galactic rotation curves.',
            '6': 'Scale free dynamics are observed in a variety of physical and biological systems. These include neural activity in which evidence for scale freeness has been reported using a range of imaging modalities. Here, we derive the ways in which connections within a network must transform - relative to system size - in order to maintain scale freeness and test these theoretical transformations via simulations. First, we explore the known invariance of planetary motion for orbits varying in size. Using parametric empirical Bayesian modelling and a generic dynamical systems model, we show that we recover Kepler\'s third law from orbital timeseries, using our proposed transformations; thereby providing construct validation. We then demonstrate that the dynamical critical exponent is inversely proportional to the time rescaling exponent, in the context of coarse graining operations. Using murine calcium imaging data, we then show that the dynamical critical exponent can be estimated in an empirical biological setting. Specifically, we compare dynamical critical exponents - associated with spontaneous and task states in two regions of imaged cortex - that are classified as task-relevant and task-irrelevant. We find, consistently across animals, that the task-irrelevant region exhibits higher dynamical critical exponents during spontaneous activity than during task performance. Conversely, the task-relevant region is associated with higher dynamical critical exponents in task vs. spontaneous states. These data support the idea that higher dynamical critical exponents, within relevant cortical structures, underwrite neuronal processing due to the implicit increase in cross-scale information transmission.',
            '7': 'In order to probe the mechanism of variations of the Solar Constant on the inter-solar-cycle scale, total solar irradiance (TSI, the so-called Solar Constant) in the time interval of 7 November 1978 to 20 September 2010 is decomposed into three components through the empirical mode decomposition and time-frequency analyses. The first component is the rotation signal, counting up to 42.31% of the total variation of TSI, which is understood to be mainly caused by large magnetic structures, including sunspot groups. The second is an annual-variation signal, counting up to 15.17% of the total variation, the origin of which is not known at this point in time. Finally, the third is the inter-solar-cycle signal, counting up to 42.52%, which are inferred to be caused by the network magnetic elements in quiet regions, whose magnetic flux ranges from $(4.27-38.01)\\times10^{19}$ Mx.',
            '8': 'On 10 August 2014, an extraordinary spacecraft will return to Earth after having been away for 30 years. Plans are emerging and actions are being taken to reactivate the International Sun-Earth Explorer 3 (ISEE 3, later renamed the International Cometary Explorer (ICE)) and enable it to gather new scientific data. The NASA-European Space Agency ISEE pioneered the multipoint approach to studying solar-terrestrial connections. ISEE 1 and ISEE 2 were launched in 1977, and ISEE 3 was launched in 1978. These spacecraft were designed to explore the relationship between the incoming solar wind (sampled by ISEE 3) and Earth\'s magnetosphere (sampled by ISEE 1 and ISEE 2). ISEE 3 is notable for many space firsts. It was the first spacecraft in a \u201chalo orbit\u201d around the Sun-Earth L1 libration point. Later, it became the first spacecraft to intercept a comet when, after being renamed ICE, it was sent to comet Giacobini-Zinner in 1985. After a distant encounter with Halley\'s comet in 1986, ISEE 3/ICE continued on its heliocentric orbit. In August 2014, this trajectory will bring the spacecraft on a close approach with Earth and will provide an opportunity to return it to active service. The spacecraft carries 13 plasma, high-energy particle, field, and wave sensors, most of which were still functional as of 1999. The current health of these instruments needs to be evaluated, but a test in 2008 confirmed ISEE 3/ICE\'s location and clearly detected the spacecraft carrier signal. The spacecraft has sufficient fuel (approximately 150 meters per second of change in velocity (?V) capability) to send it back to L1. Much of the documentation from the initial mission programming was lost, but members of the original team are now working on rebuilding the commands necessary for spacecraft control and data acquisition. Once these commands are rebuilt, the Deep Space Network will be used to communicate with the spacecraft and determine instrument health. Demonstrating that we can communicate with the spacecraft and that it is sufficiently healthy is a crucial step toward a new mission in 2014. On what new adventures do we send our venerable explorer? One option is that it could return to the L1 halo orbit. Much more is known about space weather now than was known 30 years ago. Even so, multipoint space weather monitoring and research are more important than ever, and this spacecraft is an exceptional candidate to serve as a space weather monitor providing complementary and cost-effective measurements of the solar wind. However, ISEE 3/ICE can serve many more purposes. Controlling this comparatively simple spacecraft, now well beyond warranty, would be an ideal training opportunity for young scientists and engineers. A single PC, for example, could support the entire ground system, a prime example of NASA\'s ability to do \u201cmore with less.\u201d For more information on ISEE 3, see http://nssdc.gsfc.nasa.gov/nmc/spacecraftDisplay.do?id=1978-079A. Leonard Garcia is a research scientist working for Wyle Information Systems at NASA Goddard Space Flight Center, Greenbelt, Md. E-mail: leonard.n.garcia@nasa.gov. Robert Farquhar is Executive for Space Exploration at KinetX, Inc., Tempe, Ariz. Timothy Eastman is a research scientist working for Wyle Information Systems at NASA Goddard Space Flight Center, Greenbelt, Md.',
            '9': 'Over 100 trigonometric parallaxes and proper motions for masers associated with young, high-mass stars have been measured with the BeSSeL Survey, a VLBA key science project, the EVN, and the Japanese VERA project. These measurements provide strong evidence for the existence of spiral arms in the Milky Way, accurately locating many arm segments and yielding spiral pitch angles ranging from 7 to 20 degrees. The widths of spiral arms increase with distance from the Galactic center. Fitting axially symmetric models of the Milky Way with the 3-D position and velocity information and conservative priors for the solar and average source peculiar motions, we estimate the distance to the Galactic center, Ro, to be 8.34 +/- 0.16 kpc, a circular rotation speed at the Sun, To, to be 240 +/- 8 km/s, and a rotation curve that is nearly flat (a slope of -0.2 +/- 0.4 km/s/kpc) between Galactocentric radii of 5 and 16 kpc. Assuming a \'universal\' spiral galaxy form for the rotation curve, we estimate the thin disk scale length to be 2.44 +/- 0.16 kpc. The parameters Ro and To are not highly correlated and are relatively insensitive to different forms of the rotation curve. Adopting a theoretically motivated prior that high-mass star forming regions are in nearly circular Galactic orbits, we estimate a global solar motion component in the direction of Galactic rotation, Vsun = 14.6 +/- 5.0 km/s. While To and Vsun are significantly correlated, the sum of these parameters is well constrained, To + Vsun = 255.2 +/- 5.1 km/s, as is the angular speed of the Sun in its orbit about the Galactic center, (To + Vsun)/Ro = 30.57 +/- 0.43 km/s/kpc. These parameters improve the accuracy of estimates of the accelerations of the Sun and the Hulse-Taylor binary pulsar in their Galactic orbits, significantly reducing the uncertainty in tests of gravitational radiation predicted by general relativity.',
            '10': 'Petr Beckmann\'s Einstein Plus Two (1987). [2] Beckmann\'s assumption was that the luminiferous medium, which Michelson failed to detect in 1887, is the local gravitational field, which attenuates with distance from the gravitating body. Overwhelmingly, we are in the Earth\'s field, which does not rotate with the Earth\u2019s rotation. This accounts for the Michelson-Morley null result and predicts an east-west light speed difference and with it a small fringe shift. An \u201cether\u201d denser near the sun predicts the bending of light rays by Fermat\'s Principle, and the gravitational red shift. Einstein\'s equation accounting for Mercury\'s orbit was published by Paul Gerber, 17 years before general relativity. Both Sagnac (1913) and Michelson-Gale (1924) showed a fringe shift, but were disqualified as tests of SRT because they involved rotating (non-inertial) reference frames. GPS is said to validate special relativity because relativistic adjustments are entered into the orbiting clocks and would not synchronize without them. But the corrections do not refer clock motion to the observer, as relativity requires, but to the non-rotating Earth centered, inertial reference frame. It is a preferred reference frame \u2014 not allowed by SRT. The same criticism applies to the Hafele-Keating experiment (1972), in which atomic clocks flown around the world showed an east-west time difference. After 1916, Einstein restored a \u201cgravitational ether,\u201d indistinguishable from Beckmann\'s, but played it down. The book concludes that general relativity gives the right results by a roundabout method. SRT has been falsified, unless rescued by the claim that all experiments on the surface of a rotating globe are non-inertial.',
            '11': 'Science & Society4 August 2015free access Herding, social influences and behavioural bias in scientific research Simple awareness of the hidden pressures and beliefs that influence our thinking can help to preserve objectivity Michelle Baddeley Michelle Baddeley [email protected] University College London, London, UK Search for more papers by this author Michelle Baddeley Michelle Baddeley [email protected] University College London, London, UK Search for more papers by this author Author Information Michelle Baddeley1 1University College London, London, UK EMBO Reports (2015)16:902-905https://doi.org/10.15252/embr.201540637 PDFDownload PDF of article text and main figures. ToolsAdd to favoritesDownload CitationsTrack CitationsPermissions ShareFacebookTwitterLinked InMendeleyWechatReddit Figures & Info The mission of scientific research is to understand and to discover the cause or mechanism behind an observed phenomenon. The main tool employed by scientists is the scientific method: formulate a hypothesis that could explain an observation, develop testable predictions, gather data or design experiments to test these predictions and, based on the result, accept, reject or refine the hypothesis. In practice, however, the path to understanding is often not straightforward: uncertainty, insufficient information, unreliable data or flawed analysis can make it challenging to untangle good theories, hypotheses and evidence from bad, though these problems can be overcome with careful experimental design, objective data analysis and/or robust statistics. Yet, no matter how good the experiment or how clean the data, we still need to account for the human factor: researchers are subject to unconscious bias and might genuinely believe that their analysis is wholly objective when, in fact, it is not. Bias can distort the evolution of knowledge if scientists are reluctant to accept an alternative explanation for their observations, or even fudge data or their analysis to support their preconceived beliefs. This article highlights some of the biases that have the potential to mislead academic research. Among them, heuristics and biases generally and social influences in particular, can have profoundly negative consequences for the wider world, especially if misleading research findings are used to guide public policy or affect decision-making in medicine and beyond. The challenge is to become aware of biases and separate the bad influences from the good. Sometimes social influences play a positive role\u2014for example, by enabling social learning. Condorcet\'s \u201cjury principle\u201d is another example of the power of collective wisdom: the collective opinion of a jury\u2014in which each individual juror has just a slightly better than average chance of matching the correct verdict\u2014is more likely to reach the correct verdict, but only if the individuals\' judgements are uncorrelated. In other situations, social influence and collective opinions are unhelpful\u2014for example, if people follow a group consensus even though they have private information which conflicts with the consensus. If researchers are aware of these pitfalls and the biases to which they might be prone, this greater awareness will help them interpret results as objectively as possible and base all their judgements on robust evidence. Many mistakes that people make are genuine and reflect systematic cognitive biases. Such biases are not necessarily irrational, in the sense of being stupid, because they emerge from the sensible application of heuristics or quick rules of thumb\u2014a practical approach to solve problems that is not perfect or optimal, but is sufficient for the task at hand. Herbert Simon, an American Nobel laureate in economics, political scientist, sociologist and computer scientist, analysed rationality and his insights are helpful in understanding how heuristics are linked to socio-psychological influences affecting experts\' beliefs. Simon distinguished substantive rationality\u2014when decisions have a substantive, objective basis\u2014usually based around some mathematical rule\u2014from procedural rationality, when decision-making is more sensible, intuitive, based on prior judgements, and \u201cappropriate deliberation\u201d 1. Bias can distort the evolution of knowledge if scientists are reluctant to accept an alternative explanation for their observations, or even fudge data or their analysis to support their preconceived beliefs Using heuristics is consistent with Simon\'s definition of procedural rationality: heuristics are reasoning devices that enable people to economise the costs involved in collecting information and deciding about their best options. It would be foolish to spend a week travelling around town visiting supermarkets before deciding where to buy a cheap loaf of bread. When planning a holiday, looking at customer reviews may save time and effort, even if these reviews give only a partial account. Similarly, heuristics are used in research: before we decide to read a paper, we might prejudge its quality and make a decision whether or not to read it depending on the authors\' publication records, institutional affiliations or which journal it is published in. A more reliable way to judge the quality of a paper is to read all other papers in the same field, but this would involve a large expenditure of time and effort probably not justifiable in terms of the net benefit. Most of the time, heuristics can work well, but sometimes they generate systematic cognitive/behavioural biases, which can be grouped into three main sets, as originally identified by Tversky and Kahneman: the availability heuristic, the representativeness heuristic and anchoring/adjustment 2. Availability heuristics are used when people form judgements based on readily accessible information\u2014this is often the most recent or salient information\u2014even though this information may be less relevant than other information which is harder to remember. A well-known example of the availability heuristic is people\'s subjective judgements of the risks of different types of accidents: experimental evidence shows that people are more likely to overestimate the probability of plane and train crashes either when they have had recent personal experience or\u2014more likely\u2014when they have read or seen vivid accounts in the media. Objectively, car and pedestrian accidents are more likely, but they are also less likely to feature in the news and so are harder to recall. Problems emerge in applying the availability heuristic when important and useful information is ignored. The availability heuristic also connects with familiarity bias and status quo bias: people favour explanations with which they are familiar and may therefore be resistant to novel findings and approaches. Research into the causes of stomach ulcers and gastric cancer is an illustrative example. The conventional view was that stress and poor diet causes stomach ulcers, and when Barry Marshall and colleagues showed that Helicobacter pylori was the culprit\u2014for which he received the Nobel prize with Robin Warren\u2014the findings were originally dismissed and even ridiculed, arguably because they did not fit well with the collective opinion. The representativeness heuristic is based on analogical reasoning: judging events and processes by their similarity to other events and processes. One example relevant to academic research is Tversky and Kahneman\'s \u201claw of small numbers,\u201d by which small samples are attributed with as much power as large samples. Deena Skolnick Weisberg and colleagues identified a similar problem in the application of neuroscience explanations: their experiments showed that na\u00efve adults are more likely to believe bad explanations when \u201csupported\u201d by irrelevant neuroscience and less likely to believe good explanations when not accompanied by irrelevant neuroscience 3. Finally, Kahneman and Tversky identified a category of biases associated with anchoring and adjustment heuristics. People often anchor their judgements on a reference point\u2014this may be current opinion or the strong opinions of a research leader or other opinion former. Adjustment heuristics connect with confirmation bias: people tend to interpret evidence that connects with their preconceived notions of how the world works. In this case, beliefs will be path dependent: they emerge according to what has happened before. As explored in more detail below, anchoring and adjustment heuristics can help to explain the impact of herding and other social influences\u2014when individuals anchor and adjust their own judgements around socially determined reference points, including other experts\' opinions. Social influences come in two broad forms: informational influence\u2014others\' opinions that provide useful information\u2014and normative influence\u2014agreeing with others based on socio-psychological and/or emotional factors. Informational influences are the focus of economic models of \u201crational herding\u201d and social learning, based on Bayesian reasoning processes, when decision-makers use information about the decisions and actions of others to judge the likelihood of an event. Such judgements are regularly updated according to Bayes\'s rule and therefore are driven by relatively objective and systematic information. Adopting consensus views may mean that potentially useful private information, especially novel and unexpected findings, is ignored and discarded, and so is lost to subsequent researchers Social learning models are often illustrated with the example of choosing a restaurant. When we see a crowded restaurant, we infer that its food and wine are good because it is attracting so many customers. But a person observing a crowded restaurant may also have some contradictory private information about the restaurant next door: for example, a friend might have told them that the second restaurant has much better food, wine and service; yet that second restaurant is empty. If that person decides in the end to go with the implicit group judgement that the first restaurant is better, then their hidden private information (their friend\'s opinion) gets lost. Anyone observing them would see nothing to suggest that the empty restaurant has any merit\u2014even if they have contradictory private information of their own. They too might decide, on balance, to go with the herd and queue for the first restaurant. As more and more people queue for the first restaurant, all useful private information about the superior quality of the second restaurant is lost. This problem can be profound in scientific research. Adopting consensus views may mean that potentially useful private information, especially novel and unexpected findings, is ignored and discarded and so is lost to subsequent researchers. Evidence that conflicts with established opinions can be sidelined or deemed unpublishable by reviewers who have a competing hypothesis or contrary world view. In the worst cases, the researchers who uncover evidence that fits well with unfashionable or unconventional views may be ostracised or even punished, with well-known historical examples, not least Galileo Galilei, who was convicted of heresy for his support of the Copernican heliocentric model of the solar system. Herding, fads and customs can also be explained in terms of reputation building. When people care about their status, conformity helps them to maintain status, while departing from social norms carries the risk of impaired status. Reputation also survives a loss better if others are losing at the same time. If financial traders lose large sums when others are losing at the same time, they will have a good chance of keeping their job; but if they lose a large sum implementing an unconventional trading strategy, there is a good chance they will lose their job, even if, overall, their strategy is sound and more likely to succeed than fail. People often make obvious mistakes when they observe others around them making similar mistakes. In social psychology experiments, when asked to judge the similarity in length of a set of lines, subjects were manipulated into making apparently obvious mistakes when they observed experimental confederates deliberately giving the wrong answers in the same task\u2014they may agree with others because it is easier and less confusing to conform 4. The propensity to herd is strong and reflects social responses that were hard-wired during evolution and reinforced via childhood conditioning. Insights from neurobiology and evolutionary biology help to explain our herding tendencies\u2014survival chances are increased for many animals when the group provides safety and/or gives signals about the availability of food or mates. Some neuroscientific evidence indicates that, partly, herding activates neural areas that are older and more primitive in evolutionary terms 5. Herding also reflects childhood conditioning. Children copy adult behaviours, and children who have seen adults around them behaving violently may be driven by instinctive imitation to behave violently too 6. Social influences, including social pressure, groupthink and herding effects, are powerful in scientific research communities, where the path of scientific investigation may be shaped by past events and others\' opinions. In these situations, expert elicitation\u2014collecting information from other experts\u2014may be prone to socially driven heuristics and biases, including group bias, tribalism, herding and bandwagon effects. Baddeley, Curtis and Wood explored herding in \u201cexpert elicitation\u201d in geophysics 7. In geologically complex rock formations, uncertainty and poor/scarce data limit experts\' ability to accurately identify the probability of oil resources. Bringing together experts\' opinions has the potential to increase accuracy, assuming Condorcet\'s jury principle about the wisdom of crowds holds, and this rests, as noted above, on the notion that individuals\' prior opinions are uncorrelated. Instead, expert elicitation is often distorted by herding and conventional opinions and conformist views will therefore be overweighted. The propensity to herd is strong and reflects social responses that were hard-wired during evolution and reinforced via childhood conditioning Perverse incentives exacerbate the problem. When careers depend on research assessment and the number of publications in established journals, the incentives tip towards following the crowd rather than publicising unconventional theories or apparently anomalous findings 8. When herding influences dominate, the accumulation of knowledge is distorted. Using computational models, Michael Weisberg showed that, with a greater proportion of contrarians in a population, a wider range of knowledge will be uncovered 9. We need contrarians as they encourage us to pursue new directions and take different approaches. The willingness to take risks in research generates positive externalities, for example: new knowledge that the herd would not be able to discover if they stick to conformist views. Scientific evidence can and should be interpreted keeping these biases in mind In the worst case, social influences may allow fraudulent or deliberately distorted results to twist research if personal ambition, preoccupation with academic status and/or vested interests dominate. A recent illustration was the Diederik Stapel case: Stapel is a social psychologist and he manipulated his data from studies of the impact of disordered environments on antisocial behaviour. Marc Hauser, a former professor of psychology at Harvard University, published influential papers in top journals on animal behaviour and cognition, until an investigation found him guilty of scientific misconduct in 2011. Both were influential, leading figures in their field, and their results were unchallenged for many years, partly because members of their research groups and other researchers felt unable to challenge them. Their reputations as leading figures in their fields meant it took longer for whistle-blowers and critiques questioning the integrity of their data and findings to have an impact. Deliberate fraud is rare. More usually, mistakes result from the excessive influence of scientific conventions, ideological prejudices and/or unconscious bias; well-educated, intelligent scientists are as susceptible to these as anyone else. Subtle, unconscious conformism is likely to be far more dangerous to scientific progress than fraud: it is harder to detect, and if researchers are not even aware of the power of conventional opinions to shape their hypotheses and conclusions, then conformism can have a detrimental impact in terms of human wellbeing and scientific progress. These problems are likely to be profound, especially in new fields of research. A research paper that looks and sounds right and matches a discipline\'s conventions and preconceptions is more likely to be taken seriously irrespective of its scientific merit. This was illustrated in the case of the Sokal hoax in which a well-written but deliberately nonsensical research paper passed through refereeing processes in social science journals, arguably because it rested well with reviewers\' preconceptions. Another salient example is tobacco research: initial evidence about a strong correlation between cigarette smoking and lung cancer was dismissed on the grounds that correlation does not imply causation, with some researchers\u2014including some later hired as consultants by tobacco companies\u2014making what now seems an absurd claim that the causation went in reverse with lung cancer causing cigarette smoking 10. Other group influences reflect hierarchies and experience, if, for instance, junior members of a research laboratory instinctively imitate their mentors, defer to their supervisors\' views and opinions and/or refrain from disagreeing. When researchers\u2014particularly young researchers with careers to forge\u2014feel social pressure to conform to a particular scientific view, it can be difficult to contradict that view, leading to path dependency and inertia. Scientific evidence can and should be interpreted keeping these biases in mind. If researchers support an existing theory or hypothesis because it has been properly verified, it does not mean that the consensus is wrong. More generally, social influences can play a positive role in research: replicating others\' findings is an undervalued but important part of science. When a number of researchers have repeated and verified experimental results, findings will be more robust. Problems emerge when the consensus opinion reflects something other than a Bayesian-style judgement about relative likelihood. When researchers are reluctant to abandon a favoured hypothesis, for reasons that reflect socio-psychological influences rather than hard evidence, then the hypothesis persists because it is assigned excessive and undue weight. As more and more researchers support it, the likelihood that it will persist increases, and the path of knowledge will be obstructed. Journal editors and reviewers, and the research community more generally, need to recognise that herding and social influences can influence judgement and lead them to favour research findings that fit with their own preconceptions and/or group opinions as much as objective evidence. Conflict of interest The author declares that she has no conflict of interest. References Simon H (1979) From Substantive to Procedural Rationality. In Philosophy and Economic Theory, FH Hahn, M Hollis (eds). Oxford: Oxford University PressGoogle Scholar Tversky A, Kahneman D (1974) Judgment under uncertainty: heuristics and biases. Science 185: 1124\u20131131CrossrefCASPubMedWeb of Science\u00aeGoogle Scholar Weisberg DS, Keil FC, Goodstein J, Rawson E, Gray JR (2008) The seductive allure of neuroscience explanations. J Cogn Neurosci 20: 470\u2013477CrossrefPubMedWeb of Science\u00aeGoogle Scholar Asch SE (1956) Studies of independence and conformity: a minority of one against a unanimous majority. Psychol Monogr 70: 1\u201370CrossrefWeb of Science\u00aeGoogle Scholar Baddeley M (2010) Herding, social influence and economic decision-making: socio-psychological and neuroscientific analyses. Phil Trans R Soc B 365: 281\u2013290CrossrefPubMedWeb of Science\u00aeGoogle Scholar Bandura A, Ross D, Ross SA (1961) Transmission of aggression through imitation of aggressive models. J Abnorm Soc Psychol 63: 575\u2013582CrossrefCASPubMedWeb of Science\u00aeGoogle Scholar Baddeley M, Curtis A, Wood R (2005) An introduction to prior information derived from probabilistic judgments; elicitation of knowledge, cognitive bias and herding. In Geological Prior Information: Informing Science and Engineering, A Curtis, R Wood (eds), Special Publications No. 239, pp 15\u201327. London: Geological SocietyGoogle Scholar Baddeley M (2013) Herding, social influence and expert opinion. J Economic Methodol 20: 37\u201345CrossrefGoogle Scholar Weisberg M (2013) Modeling herding behaviour and its risks. J Economic Methodol 20: 6\u201318CrossrefGoogle Scholar Harford T (2014). Big data: are we making a big mistake? The Financial Times Magazine, 28 March 2014. Downloaded 28 May 2015 from http://www.ft.com/cms/s/2/21a6e7d8-b479-11e3-a09a-00144feabdc0.htmlGoogle Scholar Previous ArticleNext Article Read MoreAbout the coverClose modalView large imageVolume 16,Issue 8,August 2015Cover: Mouse pre-implantation embryo at hatching. The cells in green, positive for a pluripotency marker Sox2, will give rise to all the tissues within the animal body. The cells in cyan, positive for a lineage marker newly identified in the gene-trap screen, will contribute to both the embryonic and the extra-embryonic tissues. The cell membranes are shown in magenta. From Jens-Erik Dietrich, Laura Panavaite, Takashi Hiiragi and colleagues: Venus trap in the mouse embryo reveals distinct molecular dynamics underlying specification of first embryonic lineages. For details, see the Article on p 1005. \u00a9 Cover image by Laura Panavaite, EMBL. Volume 16Issue 81 August 2015In this issue ReferencesRelatedDetailsLoading ...',
        },
        'doi': {
            '1': 'https://doi.org/10.1111/j.1365-2486.2007.01433.x',
            '2': 'https://doi.org/10.1073/pnas.0608379104',
            '3': 'https://doi.org/10.1029/2006gl028946',
            '4': 'https://doi.org/10.1146/annurev-virology-012420-022445',
            '6': 'https://doi.org/10.1890/07-0712.1',
            '7': 'https://doi.org/10.3390/rs5104799',
            '8': 'https://doi.org/10.1038/ismej.2009.108',
            '9': 'https://doi.org/10.5951/mt.90.7.0528',
            '10': 'https://doi.org/10.5194/hess-15-1291-2011',
            '11': 'https://doi.org/10.3390/rs2041057',
        },
    }


def empty_search_data():
    return {"openalex_id": {}, "title": {}, "abstract": {}, 'doi': {}}


def evidence() -> dict:
    ev = {
        'Evidence 1': {
            'ID': 'https://openalex.org/W3102087921',
            'DOI': 'https://doi.org/10.5951/mt.90.7.0528',
            'Score': 'high',
            'Verdict': 'support',
            'Explanation': "The article provides evidence for the existence of spiral arms in the Milky Way, accurately locating many arm segments and yielding spiral pitch angles ranging from 7 to 20 degrees. This supports the assertion that the Earth's orbit around the Sun is responsible for the changing seasons.",
        },
        'Evidence 2': {
            'ID': 'https://openalex.org/W2022734373',
            'DOI': 'https://doi.org/10.3390/rs5104799',
            'Score': 'medium',
            'Verdict': 'contradict',
            'Explanation': "The article decomposes total solar irradiance (TSI) into three components, one of which is the rotation signal, counting up to 42.31% of the total variation of TSI, which is understood to be mainly caused by large magnetic structures, including sunspot groups. This contradicts the assertion that the Earth's rotation is responsible for the changing seasons, as the rotation signal is caused by magnetic structures on the Sun, not the Earth's rotation.",
        },
        'Evidence 3': {
            'ID': 'https://openalex.org/W2762533726',
            'DOI': 'https://doi.org/10.1073/pnas.0608379104',
            'Score': 'low',
            'Verdict': 'contradict',
            'Explanation': 'The article describes an example in planetary orbital theory, whose various Sun- and Earth-centred coordinate systems makes that theory a good test-bed for such an exposition of changing coordinates. However, it does not provide direct evidence that supports or contradicts the assertion.',
        },
        'Summary': 'One article provides evidence for the existence of spiral arms in the Milky Way, accurately locating many arm segments and yielding spiral pitch angles ranging from 7 to 20 degrees, which supports the assertion. Another article decomposes total solar irradiance (TSI) into three components, one of which is the rotation signal, counting up to 42.31% of the total variation of TSI, which is understood to be mainly caused by large magnetic structures, including sunspot groups, which contradicts the assertion. One article does not provide direct evidence that supports or contradicts the assertion.',
        'Final Verdict': 'partially substantiated',
    }
    return {'output_text': json.dumps(ev)}


def empty_evidence() -> dict:
    ev = {}
    return {'output_text': json.dumps(ev)}


def existing_state_from(**kwargs):
    return AssertionsCreatorState(
        id=uuid.UUID('691c5615-ce6c-476e-9155-e451e359ce8f'),
        chat_id=uuid.UUID('8ff3e8e7-6d69-4070-b3f9-c25d7efc36c6'),
        user='anonymous',
        chat_ts=util.parse_ts('2023-05-16T21:45:10.460757Z'),
        ts=util.parse_ts('2023-05-16T21:45:10.460757Z'),
        extra={'extra1': 'extra1-value', 'extra2': 'extra2-value'},
        **kwargs,
    )


@pytest.fixture()
def apigw_event(base_dir: Path) -> dict:
    with open(base_dir / 'sam/events/unit-test-step-evidence-creator-event.json') as f:
        return json.load(f)


@pytest.mark.parametrize('existing_state,search_data,evidence,expected_status_code,expected_body_keys', [(
        existing_state_from(
            assertion='The Earth\'s rotation and orbit around the Sun are responsible for the changing seasons.'),
        search_data(),
        evidence(),
        200,
        {'id', 'chat_id', 'chat_ts'},
), (
        existing_state_from(assertion='There are only about 100 individuals of Rice\'s whale remaining.'),
        empty_search_data(),
        empty_evidence(),
        400,
        {'error', 'chat_id', 'chat_ts'},
)])
def test_lambda_handler(apigw_event: dict, existing_state: AssertionsCreatorState, search_data: dict, evidence: dict,
                        expected_status_code: int, expected_body_keys: typing.Set[str],
                        mock_env, mocker) -> None:
    now = datetime.utcnow().replace(tzinfo=timezone.utc)
    bucket_name = apigw_event['stageVariables']['chatbot_requests_bucket']
    subject = 'anonymous'

    openalex_ids, titles, abstracts, doi = itemgetter('openalex_id', 'title', 'abstract', 'doi')(search_data)
    search_results = [
        {'score': random(), 'content': f'ID: {i} TITLE: {t}. ABSTRACT: {a}', 'DOI': d}
        for i, t, a, d in zip(openalex_ids.values(), titles.values(), abstracts.values(), doi.values())
    ]
    corpus_df = pd.DataFrame.from_dict(search_data)

    from func_step_evidence_creator.app.corpus_container import (
        RemoteCorpusContainerProxy,
    )

    mock_env['llm_name'] = 'chat_openai'

    with mock.patch("chatbot_cloud_util.util.datetime") as mocked_dt, mock.patch.object(
            RemoteCorpusContainerProxy, "search", lambda *a, **kw: search_results
    ), mock.patch.object(
        RemoteCorpusContainerProxy, "size_of_corpus", lambda *a, **kw: len(search_results)
    ), mock.patch.object(
        CorpusChain, "__call__", lambda *a, **kw: corpus_df
    ), mock.patch.object(
        CorpusCreator, "_get_embeddings", lambda a: FakeEmbeddings(size=100)
    ), mock.patch.object(
        CorpusContainer, "emb", FakeEmbeddings(size=100)
    ), mock.patch.object(
        Evidence, "__call__", lambda *a, **kw: evidence
    ), mock.patch.object(
        WebSocketEnabledApiGatewayEvent, "_send_ws_message", lambda *a, **kw: None
    ), mock_s3(), mock_secretsmanager():
        mocked_dt.utcnow = mock.Mock(return_value=now)

        sm_client = boto3.client('secretsmanager', region_name='us-east-1')
        sm_client.create_secret(Name='openai-secret-key', SecretString='secret')
        sm_client.create_secret(Name='jwt-secret-key', SecretString='secret')

        s3_client = boto3.client('s3', region_name='us-east-1')
        s3_client.create_bucket(Bucket=bucket_name)

        s3_client.put_object(
            Bucket=bucket_name,
            Key=str(Path(f'{str(existing_state.id)}.json')),
            Body=existing_state.to_json().encode('utf-8'),
        )

        from func_step_evidence_creator.app import lambda_handler

        test_response = lambda_handler(apigw_event, mock.Mock())
        assert test_response['statusCode'] == expected_status_code
        body = json.loads(test_response['body'])
        assert expected_body_keys.issubset(set(body.keys()))

        if test_response['statusCode'] == 200:
            conn = boto3.resource('s3', region_name='us-east-1')
            payload = conn.Object(bucket_name, str(Path(f'{body["id"]}.json'))).get()['Body'].read().decode('utf-8')
            saved_state = EvidenceCreatorState(**json.loads(payload))

            state = EvidenceCreatorState(
                id=saved_state.id,
                chat_id=existing_state.chat_id,
                user=subject,
                chat_ts=existing_state.chat_ts,
                ts=now,
                assertion_id=existing_state.id,
                evidence=saved_state.evidence,  # will not validate evidence itself
                extra={'extra1': 'extra1-value', 'extra2': 'extra2-value'},
            )
            assert saved_state == state
